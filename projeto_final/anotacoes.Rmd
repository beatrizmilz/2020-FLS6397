---
title: "Anotações do projeto final"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message =  FALSE)
```


```{r include=FALSE}
library(readxl)
library(tidyverse)
library(sf)
```

- Dados para os anos 2016, 2017 e 2018, da CETESB, sobre saneamento por município no estado de SP.

- Os dados originais estão disponíveis em um PDF, no seguinte link: https://cetesb.sp.gov.br/aguas-interiores/wp-content/uploads/sites/12/2019/10/Ap%C3%AAndice-C_Dados-de-Saneamento-por-Munic%C3%ADpio.pdf

- Não consegui converter para o R em uma forma automática.

- Passos: 
  - Salvei apenas as páginas do Apendice C que continham partes da tabela (arquivo cortado)
  - Fiz a conversão no site https://pdftables.com/ - download em csv
  - Abrir a base

para 2016: não foi disponibilizado como tabela, e sim como imagem.

tutorial legal: https://www.curso-r.com/blog/2017-11-23-union-sf/

```{r}

dados_2018 <- read_csv(
  "dados_brutos/2018.csv",
  locale = locale(decimal_mark = ",",
                  grouping_mark = ".",
                  encoding = "UTF-8"),
  skip = 1,
  col_names = c(
    "ugrhi",
    "municipio",
    "consessao",
    "pop_urbana",
    "atendimento_coleta_porc",
    "atendimento_tratamento_porc",
    "eficiencia",
    "carga_poluidora_potencial",
    "carga_poluidora_remancescente",
    "ictem",
    "corpo_receptor"
  ),
  
  col_types = cols(
    "ugrhi" = col_number(),
    "pop_urbana" = col_number(),
    "atendimento_coleta_porc" = col_number(),
    "atendimento_tratamento_porc" = col_number(),
    "eficiencia" = col_number(),
    "carga_poluidora_potencial"  = col_number(),
    "carga_poluidora_remancescente" = col_number(),
    "ictem" = col_number()
  ),
) %>% mutate(ano = 2018)

glimpse(dados_2018)

dados_2017 <- read_csv(
  "dados_brutos/2017.csv",
  locale = locale(decimal_mark = ",",
                  grouping_mark = "."),
  skip = 1,
  col_names = c(
    "ugrhi",
    "municipio",
    "consessao",
    "pop_urbana",
    "atendimento_coleta_porc",
    "atendimento_tratamento_porc",
    "eficiencia",
    "carga_poluidora_potencial",
    "carga_poluidora_remancescente",
    "ictem",
    "corpo_receptor"
  ),
  
  col_types = cols(
    "ugrhi" = col_number(),
    "pop_urbana" = col_number(),
    "atendimento_coleta_porc" = col_number(),
    "atendimento_tratamento_porc" = col_number(),
    "eficiencia" = col_number(),
    "carga_poluidora_potencial"  = col_number(),
    "carga_poluidora_remancescente" = col_number(),
    "ictem" = col_number()
  ),
) %>% mutate(ano = 2017)

glimpse(dados_2017)

apendice_c_bruto <- bind_rows(dados_2017, dados_2018)

```


- retirar linhas que só contém NA, e linhas que não tem dados dos municípios

```{r}
apendice_c_filtrado <- apendice_c_bruto %>% filter_all(any_vars(!is.na(.))) %>% 
  filter(!municipio %in% c("Estado de São Paulo", "Município", NA, "MUNICÍPIO")
         ) 


```


Agora a base tem `r nrow(apendice_c_filtrado)` linhas, o que corresponde com o 645 municípios do estado de SP vezes 2 (pois a base tem dados de 2 anos).



```{r}
# apendice_c_filtrado %>% arrange(-carga_poluidora_remancescente)
```



```{r}
# apendice_c_filtrado %>% filter(str_detect(corpo_receptor, 'Rio Pinheiros'), ano == 2017) %>% arrange(-pop_urbana) %>% select(carga_poluidora_remancescente) %>% summarise(sum(carga_poluidora_remancescente))
# 
# 
# apendice_c_filtrado %>% filter(str_detect(corpo_receptor, 'Billings'), ano == 2018) %>% arrange(-pop_urbana) %>% select(carga_poluidora_remancescente) %>% summarise(sum(carga_poluidora_remancescente))

```





# ------
```{r include=FALSE}
library(geobr)
geobr::list_geobr()
brasil_geo <- geobr::read_country()
estado_sp <- geobr::read_state(code_state = 35)
estado_mg <- geobr::read_state(code_state = "MG")
muni_sp <- read_municipality(code_muni = "SP", year = 2018)
muni_mg <- read_municipality(code_muni = "MG", year = 2018)

muni_sp_mg <- rbind(muni_sp, muni_mg)

# ggplot +
#   geom_sf(data = estado_sp,  aes(x = geom),         fill = "lightgray",
#           show.legend = TRUE)
# 
# library(tidyverse)

```

```{r}

muni_sp_mg_clean <-
  muni_sp_mg %>% mutate(
    municipio = stringr::str_to_upper(name_muni),
    municipio = iconv(municipio, from = 'UTF-8', to = 'ASCII//TRANSLIT'),
    municipio = str_replace_all(municipio, "[^[:alnum:]]", " "),
    municipio = str_replace_all(municipio, "SAO LUIS DO PARAITINGA", "SAO LUIZ DO PARAITINGA"),
    municipio = case_when(
      abbrev_state == "MG" ~ paste0("MG - ", municipio),
      TRUE ~ municipio
    )
  )


dados_2018 <-
  apendice_c_filtrado %>% filter(ano == 2018) %>% mutate(
    municipio = stringr::str_to_upper(municipio),
    municipio = iconv(municipio, from = 'UTF-8', to = 'ASCII//TRANSLIT'),
    municipio = str_replace_all(municipio, "[^[:alnum:]]", " "),
    municipio = str_replace_all(municipio, "SAO LUIS DO PARAITINGA", "SAO LUIZ DO PARAITINGA")
  )



 mapa_2018 <- dplyr::full_join(muni_sp_mg_clean, dados_2018) # 
```

# - 




```{r}
library(readr)
mmp <-
  read_csv("dados_mmp/mmp-daee-emplasa.csv") %>% janitor::clean_names() %>%  mutate(
    #  nome_ugrhi = stringr::str_remove_all(unidade_de_gerenciamento_de_recursos_hidricos_ugrhi, "\r\n")
    nome_ugrhi =  case_when(
      startsWith(unidade_de_gerenciamento_de_recursos_hidricos_ugrhi, "05 - ") ~ "05 - Piracicaba/Capivari/Jundiaí",
      unidade_de_gerenciamento_de_recursos_hidricos_ugrhi == "MG" ~ "05 - Piracicaba/Capivari/Jundiaí",
      TRUE ~ unidade_de_gerenciamento_de_recursos_hidricos_ugrhi
    )
  )


mmp_daee <- mmp %>% filter(recorte %in% c("EMPLASA e DAEE", "DAEE"))
```


```{r}
mapa_2018_mmp_daee <- right_join(mapa_2018, mmp_daee, by  = c("code_muni" = "codigo_ibge"))


mapa_2018_mmp_daee %>%
  count(nome_ugrhi)
```



# - 

```{r}
library(ggspatial)
library(ggthemes)
no_axis <- theme(axis.title=element_blank(),
                 axis.text=element_blank(),
                 axis.ticks=element_blank())


ggplot() +
  geom_sf() +
    # geom_sf(data = brasil_geo,
    #       fill = "lightgray",
    #       show.legend = TRUE) +
  geom_sf(data = estado_sp,
          fill = "lightgray",
          show.legend = TRUE) +
  #  geom_sf(data=estado_mg, fill = "gray")+
  geom_sf(data = mapa_2018_mmp_daee, aes(fill = nome_ugrhi), color = NA) +
    #  geom_sf(data = sp_ugrhi, fill = NA, alpha = 0.5)+
      
      # theme_minimal() +
      labs(fill = "UGRHI",
           x = "Longitude", y = "Latitude") +
      annotation_scale(location = "bl", width_hint = 0.30) +
      annotation_north_arrow(
        location = "bl",
        which_north = "true",
        height = unit(1, "cm"),
        width = unit(1, "cm"),
        pad_x = unit(0.5, "in"),
        pad_y = unit(0.3, "in"),
        style = north_arrow_fancy_orienteering
      ) +
    theme_bw()+
      theme(
        panel.grid.major = element_line(
          color = gray(0.9),
          linetype = "dashed",
          size = 0.1
           ),
        panel.background = element_rect(fill = "white")
      ) +
theme(axis.text.y = element_text(angle = 90, hjust = 0.5, size = 8),
      axis.text.x = element_text( size = 8),
      axis.title.y = element_text(size = rel(0.8)),
      axis.title.x = element_text(size = rel(0.8))
      )+
      ggsave("mapa_sp_ughri.jpeg", device = "jpeg", dpi = 600, width = 10
             , height = 5)
    
```

```{r} 
mapa_2018_mmp_daee$carga_poluidora_remancescente_color <-
  cut(mapa_2018_mmp_daee$carga_poluidora_remancescente,
     
      
      # breaks = BAMMtools::getJenksBreaks(mapa_2018_mmp_daee$carga_poluidora_remancescente, k = 10)
        
        c(
        0,
        quantile(mapa_2018_mmp_daee$carga_poluidora_remancescente, na.rm = T, probs = seq(0, 1, 0.1))[[2]],
        quantile(mapa_2018_mmp_daee$carga_poluidora_remancescente, na.rm = T, probs = seq(0, 1, 0.1))[[3]],
        quantile(mapa_2018_mmp_daee$carga_poluidora_remancescente, na.rm = T, probs = seq(0, 1, 0.1))[[4]],
        quantile(mapa_2018_mmp_daee$carga_poluidora_remancescente, na.rm = T, probs = seq(0, 1, 0.1))[[5]],
        quantile(mapa_2018_mmp_daee$carga_poluidora_remancescente, na.rm = T, probs = seq(0, 1, 0.1))[[6]],
        quantile(mapa_2018_mmp_daee$carga_poluidora_remancescente, na.rm = T, probs = seq(0, 1, 0.1))[[7]],
        quantile(mapa_2018_mmp_daee$carga_poluidora_remancescente, na.rm = T, probs = seq(0, 1, 0.1))[[8]],
        quantile(mapa_2018_mmp_daee$carga_poluidora_remancescente, na.rm = T, probs = seq(0, 1, 0.1))[[9]],
        quantile(mapa_2018_mmp_daee$carga_poluidora_remancescente, na.rm = T, probs = seq(0, 1, 0.1))[[10]],
        max(mapa_2018_mmp_daee$carga_poluidora_remancescente, na.rm = T)
      )

      , dig.lab = 10
      
      ) 


#BAMMtools::getJenksBreaks(mapa_2018_mmp_daee$carga_poluidora_remancescente, k = 10)

ggplot() +
  geom_sf(
    data = mapa_2018_mmp_daee,
    aes(fill = carga_poluidora_remancescente_color)
  ) +
  theme_minimal() +
scale_fill_viridis_d(direction = -1)+
  labs(
    fill = "Carga poluidora \n remanescente \n (kg DBO/dia)"
      
  )


```

```{r} 
mapa_2018_mmp_daee$carga_poluidora_remancescente_color <-
  cut(mapa_2018_mmp_daee$carga_poluidora_remancescente,
     
      
       breaks = BAMMtools::getJenksBreaks(mapa_2018_mmp_daee$carga_poluidora_remancescente, k = 10)
      #   
      #   c(
      #   0,
      #   quantile(mapa_2018_mmp_daee$carga_poluidora_remancescente, na.rm = T, probs = seq(0, 1, 0.1))[[2]],
      #   quantile(mapa_2018_mmp_daee$carga_poluidora_remancescente, na.rm = T, probs = seq(0, 1, 0.1))[[3]],
      #   quantile(mapa_2018_mmp_daee$carga_poluidora_remancescente, na.rm = T, probs = seq(0, 1, 0.1))[[4]],
      #   quantile(mapa_2018_mmp_daee$carga_poluidora_remancescente, na.rm = T, probs = seq(0, 1, 0.1))[[5]],
      #   quantile(mapa_2018_mmp_daee$carga_poluidora_remancescente, na.rm = T, probs = seq(0, 1, 0.1))[[6]],
      #   quantile(mapa_2018_mmp_daee$carga_poluidora_remancescente, na.rm = T, probs = seq(0, 1, 0.1))[[7]],
      #   quantile(mapa_2018_mmp_daee$carga_poluidora_remancescente, na.rm = T, probs = seq(0, 1, 0.1))[[8]],
      #   quantile(mapa_2018_mmp_daee$carga_poluidora_remancescente, na.rm = T, probs = seq(0, 1, 0.1))[[9]],
      #   quantile(mapa_2018_mmp_daee$carga_poluidora_remancescente, na.rm = T, probs = seq(0, 1, 0.1))[[10]],
      #   max(mapa_2018_mmp_daee$carga_poluidora_remancescente, na.rm = T)
      # )

      , dig.lab = 10
      
      ) 


#BAMMtools::getJenksBreaks(mapa_2018_mmp_daee$carga_poluidora_remancescente, k = 10)

ggplot() +
  geom_sf(
    data = mapa_2018_mmp_daee,
    aes(fill = carga_poluidora_remancescente_color)
  ) +
  theme_minimal() +
scale_fill_viridis_d(direction = -1)+
  labs(
    fill = "Carga poluidora \n remanescente \n (kg DBO/dia)"
      
  )


```

```{r}
ggplot() +
  geom_sf(data = mapa_2018_mmp_daee, aes(fill = ictem))+
  theme_minimal() +
  scale_fill_continuous(type = "viridis")+
#  facet_wrap(~nome_ugrhi)  +
  no_axis+
  theme_map()+
  theme(legend.position="right")
```

# ----------


é possível prever ictem a partir dos dados?

```{r}
library(tidymodels)
especificacao_lm <- linear_reg() %>%
  set_engine("lm") %>% 
  set_mode("regression")


modelo_linear <- especificacao_lm %>% 
  fit(carga_poluidora_potencial ~ pop_urbana, data = apendice_c_filtrado)


summary(modelo_linear$fit)

ggplot(apendice_c_filtrado, aes(x = pop_urbana, y = carga_poluidora_remancescente)) + 
  geom_point() +
  stat_smooth(method = "lm", col = "red")

```

